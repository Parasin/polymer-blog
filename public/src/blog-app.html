<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">

<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="blog-home.html">
<link rel="import" href="blog-login-dialog.html">
<link rel="import" href="blog-profile.html">

<dom-module id="blog-app">

	<template>

		<style>

			:host {
				display                       : block;
				position                      : relative;
				padding-top                   : 130px;
				padding-bottom                : 64px;
				min-height                    : 100vh;
				--app-primary-color           : #202020;
				--app-secondary-color         : #757575;
				--app-accent-color            : #172C50;
				--paper-button-ink-color      : var(--app-accent-color);
				--paper-icon-button-ink-color : var(--app-accent-color);
				--paper-spinner-color         : var(--app-accent-color);
				-webkit-tap-highlight-color   : rgba(0, 0, 0, 0);
				color                         : var(--app-primary-color);
			}

			app-header {
				@apply --layout-fixed-top;
				z-index          : 1;
				background-color : rgba(255, 255, 255, 0.95);
								 --app-header-shadow: {
									 box-shadow : inset 0px 5px 6px -3px rgba(0, 0, 0, 0.2);
									 height     : 10px;
									 bottom     : -10px;
								 };
			}

			paper-icon-button {
				color : var(--app-primary-color);
			}

			@-webkit-keyframes fade-in{
				0% {
					opacity : 0;
				}
				100% {
					opacity : 1;
				}
			}

			@keyframes fade-in{
				0% {
					opacity : 0;
				}
				100% {
					opacity : 1;
				}
			}

			paper-icon-button.fade-in {
				-webkit-animation-duration  : 1s;
				animation-duration          : 1s;
				-webkit-animation-fill-mode : both;
				animation-fill-mode         : both;
				-webkit-animation-name      : fade-in;
				animation-name              : fade-in;
			}

			paper-button:disabled,
			paper-button[disabled] {
				border           : 1px solid #999999;
				background-color : #cccccc;
				color            : #666666;
			}

			@-webkit-keyframes bounce {
				0% {
					-webkit-transform : translateY(0);
					opacity           : 0;
				}
				20% {
					-webkit-transform : translateY(0);
				}
				50% {
					-webkit-transform : translateY(0);
				}
				40% {
					-webkit-transform : translateY(-25px);
				}
				60% {
					-webkit-transform : translateY(-15px);
				}
				80% {
					-webkit-transform : translateY(0);
				}
				100% {
					-webkit-transform : translateY(0);
					opacity           : 1;
				}
			}

			@keyframes bounce {
				0% {
					-webkit-transform : translateY(0);
					opacity           : 0;
				}
				20% {
					-webkit-transform : translateY(0);
				}
				50% {
					-webkit-transform : translateY(0);
				}
				40% {
					-webkit-transform : translateY(-25px);
				}
				60% {
					-webkit-transform : translateY(-15px);
				}
				80% {
					-webkit-transform : translateY(0);
				}
				100% {
					-webkit-transform : translateY(0);
					opacity           : 1;
				}
			}

			.loginSuccess /*[href*="w3schools"]*/
			{
				-webkit-animation-name      : bounce;
				animation-name              : bounce;
				color                       : #0b8043;
				height                      : 40px;
				width                       : 40px;
				top                         : 15px;
				position                    : relative;
				float                       : right;
				-webkit-animation-duration  : 1s;
				animation-duration          : 1s;
				-webkit-animation-fill-mode : both;
				animation-fill-mode         : both;
			}

			.logo {
				text-align : center;
			}

			.logo a {
				font-size       : 16px;
				font-weight     : 600;
				letter-spacing  : 0.3em;
				color           : var(--app-primary-color);
				text-decoration : none;
				/* required for IE 11, so this <a> can receive pointer events */
				display         : inline-block;
				pointer-events  : auto;
			}

			.left-bar-item {
				width : 40px;
			}

			.menu-btn {
				display : none;
			}

			.cart-btn-container {

			}

			.announcer {
				position : fixed;
				height   : 0;
				overflow : hidden;
			}

			:host(:not([page=detail])) .back-btn {
				display : none;
			}

			[hidden] {
				display : none !important;
			}

			#tabContainer {
				position : relative;
				height   : 66px;
			}

			shop-tabs, shop-tab {
				--shop-tab-overlay: {
					border-bottom : 2px solid var(--app-accent-color);
				};
			}

			shop-tabs {
				height : 100%;
			}

			shop-tab {
				margin : 0 10px;
			}

			shop-tab a {
				display         : inline-block;
				outline         : none;
				padding         : 9px 5px;
				font-size       : 13px;
				font-weight     : 500;
				text-decoration : none;
				color           : var(--app-primary-color);
			}

			.cart-badge {
				position         : absolute;
				top              : -2px;
				right            : 0;
				width            : 20px;
				height           : 20px;
				background-color : var(--app-accent-color);
				border-radius    : 50%;
				color            : white;
				font-size        : 12px;
				font-weight      : 500;
				pointer-events   : none;
				@apply --layout-vertical;
				@apply --layout-center-center;
			}

			.drawer-list {
				margin : 0 20px;
			}

			.drawer-list a {
				display         : block;
				padding         : 0 16px;
				line-height     : 40px;
				text-decoration : none;
				color           : var(--app-secondary-color);
			}

			.drawer-list a.iron-selected {
				color       : black;
				font-weight : bold;
			}

			shop-cart-modal {
				z-index : 2;
			}

			app-drawer {
				z-index : 3;
			}

			iron-pages {
				max-width : 1440px;
				margin    : 0 auto;
			}

			footer {
				position    : absolute;
				bottom      : 0;
				left        : 0;
				right       : 0;
				text-align  : center;
				margin-top  : 20px;
				line-height : 24px;
			}

			footer > a {
				color           : var(--app-secondary-color);
				text-decoration : none;
			}

			footer > a:hover {
				text-decoration : underline;
			}

			.demo-label {
				box-sizing       : border-box;
				width            : 120px;
				padding          : 6px;
				margin           : 8px auto 0;
				background-color : var(--app-primary-color);
				color            : white;
				text-transform   : uppercase;
			}

			/* small screen */
			@media (max-width : 767px) {
				:host {
					padding-top : 64px;
				}

				.menu-btn {
					display : block;
				}

				:host([page=detail]) .menu-btn {
					display : none;
				}
			}

		</style>

		<!--
		  app-location and app-route elements provide the state of the URL for the app.
		-->
		<app-location route="{{route}}"></app-location>
		<app-route
				route="{{route}}"
				pattern="/:page"
				data="{{routeData}}"
				tail="{{subroute}}"></app-route>

		<iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>


		<app-header role="navigation" id="header" effects="waterfall" condenses reveals>
			<app-toolbar>
				<div class="left-bar-item">
					<paper-icon-button
							class="menu-btn"
							icon="menu"
							on-click="_toggleDrawer"
							aria-label="Categories">
					</paper-icon-button>
					<a class="back-btn" href="/list/[[categoryName]]" tabindex="-1">
						<paper-icon-button icon="arrow-back" aria-label="Go back"></paper-icon-button>
					</a>
				</div>
				<div class="logo" main-title><a href="/" aria-label="Blog Home"><!--Evan - Blog-->Welcome</a></div>
				<span class="cart-btn-container">
					<span hidden$="[[ token ]]">
						<paper-icon-button id="loginBtn"
										   icon="account-circle"
										   aria-label="Log in"
										   class="fade-in"
										   on-tap="_openDialog">
						</paper-icon-button>
						<paper-tooltip for="loginBtn">Login</paper-tooltip>
					</span>
					<span hidden$="[[ !token ]]">
						<a href$="/profile/[[ user._id ]]" tabindex="-1">
							<paper-icon-button id="profileBtn"
											   icon="face"
											   class="account-cirlce"
											   aria-label="Profile">
							</paper-icon-button>
							<paper-tooltip for="profileBtn">Profile</paper-tooltip>
						</a>
						<paper-icon-button id="logoutBtn"
										   icon="exit-to-app"
										   aria-label="Log out"
										   class="fade-in"
										   on-tap="_logOut">
						</paper-icon-button>
						<paper-tooltip for="logoutBtn">Logout</paper-tooltip>
					</span>
					</div>
			</app-toolbar>

			<!-- Lazy-create the tabs for larger screen sizes. -->
			<div id="tabContainer" sticky$="[[_shouldShowTabs]]" hidden$="[[!_shouldShowTabs]]">
				<dom-if if="[[_shouldRenderTabs]]">
					<template>
						<shop-tabs
								selected="[[categoryName]]"
								attr-for-selected="name">
							<dom-repeat items="[[categories]]" as="category" initial-count="4">
								<template>
									<shop-tab name="[[category.name]]">
										<a href="/list/[[category.name]]">[[category.title]]</a>
									</shop-tab>
								</template>
							</dom-repeat>
						</shop-tabs>
					</template>
				</dom-if>
			</div>
		</app-header>

		<!-- Lazy-create the drawer for small screen sizes. -->
		<dom-if if="[[_shouldRenderDrawer]]">
			<template>
				<!-- Two-way bind `drawerOpened` since app-drawer can update `opened` itself. -->
				<app-drawer opened="{{drawerOpened}}" swipe-open tabindex="0">
					<iron-selector role="navigation" class="drawer-list" selected="[[categoryName]]"
								   attr-for-selected="name">
						<dom-repeat items="[[categories]]" as="category" initial-count="4">
							<template>
								<a name="[[category.name]]" href="/list/[[category.name]]">[[category.title]]</a>
							</template>
						</dom-repeat>
					</iron-selector>
				</app-drawer>
			</template>
		</dom-if>

		<iron-localstorage id="localStoreToken" name="token" value="{{ token }}"></iron-localstorage>
		<iron-localstorage id="localStoreUser" name="user" value="{{ user }}"></iron-localstorage>

		<iron-pages role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="visible"
					fallback-selection="404">
			<!-- home view -->
			<blog-home name="home"></blog-home>
			<blog-profile name="profile" route="[[ subroute ]]" offline="[[ offline ]]" user="{{ user }}" token="[[ token ]]"></blog-profile>
			<!-- list view of items in a category -->
			<!--<shop-list name="list" route="[[subroute]]" offline="[[offline]]"></shop-list> -->
			<!-- detail view of one item -->
			<!--<shop-detail name="detail" route="[[subroute]]" offline="[[offline]]"></shop-detail>-->
			<!-- cart view -->
			<!--<shop-cart name="cart" cart="[[cart]]" total="[[total]]"></shop-cart>-->
			<!-- checkout view -->
			<!--<shop-checkout name="checkout" cart="[[cart]]" total="[[total]]" route="{{subroute}}"></shop-checkout>-->

			<shop-404-warning name="404"></shop-404-warning>
		</iron-pages>

		<footer>
			<a href="https://www.polymer-project.org/1.0/toolbox/">Made by Polymer</a>
			<div class="demo-label">Demo Only</div>
		</footer>

		<!-- a11y announcer -->
		<div class="announcer" aria-live="assertive">[[_a11yLabel]]</div>
		<blog-login-dialog id="loginDialog" authenticated="{{ authenticated }}"></blog-login-dialog>
	</template>

	<script>

			// performance logging
			window.performance && performance.mark && performance.mark( 'blog-app - before register' );

			class BlogApp extends Polymer.Element {

				static get is () {
					return 'blog-app';
				}

				static get properties () {
					return {
						_loginDisabled : {
							type     : Boolean,
							value    : true,
							computed : '_computeLoginDisabled(usernamePopulated, passwordPopulated)'
						},

						authenticated : {
							type   : Boolean,
							value  : false,
							notify : true
						},

						token : {
							type   : String,
							notify : true
						},

						page : {
							type               : String,
							reflectToAttribute : true,
							observer           : '_pageChanged'
						},

						_shouldShowTabs : {
							computed : '_computeShouldShowTabs(page, smallScreen)'
						},

						_shouldRenderTabs : {
							computed : '_computeShouldRenderTabs(_shouldShowTabs, loadComplete)'
						},

						_shouldRenderDrawer : {
							computed : '_computeShouldRenderDrawer(smallScreen, loadComplete)'
						}
					};
				}

				static get observers () {
					return [
						'_routePageChanged(routeData.page)',
						'_computeShouldRenderDrawer(usernameInvalid, passwordInvalid)'
					];
				}

				constructor () {
					super();
					window.performance && performance.mark && performance.mark( 'blog-app.created' );
				}

				ready () {
					super.ready();
					this.removeAttribute( 'unresolved' );
					this.addEventListener( 'change-section', ( e ) => this._onChangeSection( e ) );
					this.addEventListener( 'announce', ( e ) => this._onAnnounce( e ) );
					this.addEventListener( 'dom-change', ( e ) => this._domChange( e ) );
					this.addEventListener( 'show-invalid-url-warning', ( e ) => this._onFallbackSelectionTriggered( e ) );
					this.addEventListener( 'authenticated', ( e ) => this._authenticated( e ) );
					Polymer.RenderStatus.afterNextRender( this, () => {
						window.addEventListener( 'online', ( e ) => this._notifyNetworkStatus( e ) );
						window.addEventListener( 'offline', ( e ) => this._notifyNetworkStatus( e ) );
					} );
				}

				_routePageChanged ( page ) {
					if ( this.page === 'list' ) {
						this._listScrollTop = window.pageYOffset;
					}

					this.page = page || 'home';

					// Close the drawer - in case the *route* change came from a link in the drawer.
					this.drawerOpened = false;
				}

				_pageChanged ( page, oldPage ) {
					if ( page != null ) {
						// home route is eagerly loaded
						if ( page == 'home' ) {
							this._pageLoaded( Boolean( oldPage ) );
							// other routes are lazy loaded
						} else {
							// When a load failed, it triggered a 404 which means we need to
							// eagerly load the 404 page definition
							let cb = this._pageLoaded.bind( this, Boolean( oldPage ) );
							Polymer.importHref(
									this.resolveUrl( 'blog-' + page + '.html' ),
									cb, cb, true );
						}
					}
				}

				_pageLoaded ( shouldResetLayout ) {
					this._ensureLazyLoaded();
					if ( shouldResetLayout ) {
						// The size of the header depends on the page (e.g. on some pages the tabs
						// do not appear), so reset the header's layout only when switching pages.
						Polymer.Async.timeOut.run( () => {
							this.$.header.resetLayout();
						}, 1 );
					}
				}

				_ensureLazyLoaded () {
					// load lazy resources after render and set `loadComplete` when done.
					if ( !this.loadComplete ) {
						Polymer.RenderStatus.afterNextRender( this, () => {
							Polymer.importHref( this.resolveUrl( 'lazy-resources.html' ), () => {
								// Register service worker if supported.
								if ( 'serviceWorker' in navigator ) {
									navigator.serviceWorker.register( 'service-worker.js', { scope : '/' } );
								}
								this._notifyNetworkStatus();
								this.loadComplete = true;
							} );
						} );
					}
				}

				_notifyNetworkStatus () {
					let oldOffline = this.offline;
					this.offline   = !navigator.onLine;
					// Show the snackbar if the user is offline when starting a new session
					// or if the network status changed.
					if ( this.offline || (!this.offline && oldOffline === true) ) {
						if ( !this._networkSnackbar ) {
							this._networkSnackbar = document.createElement( 'shop-snackbar' );
							this.root.appendChild( this._networkSnackbar );
						}
						this._networkSnackbar.innerHTML = this.offline ?
								'You are offline' : 'You are online';
						this._networkSnackbar.open();
					}
				}

				_toggleDrawer () {
					this.drawerOpened = !this.drawerOpened;
				}

				// Elements in the app can notify section changes.
				// Response by a11y announcing the section and syncronizing the category.
				_onChangeSection ( event ) {
					let detail = event.detail;

					// Scroll to the top of the page when navigating to a non-list page. For list view,
					// scroll to the last saved position only if the category has not changed.
					let scrollTop = 0;
					if ( this.page === 'list' ) {
						if ( this.categoryName === detail.category ) {
							scrollTop = this._listScrollTop;
						} else {
							// Reset the list view scrollTop if the category changed.
							this._listScrollTop = 0;
						}
					}
					// Use `Polymer.AppLayout.scroll` with `behavior: 'silent'` to disable header scroll
					// effects during the scroll.
					Polymer.AppLayout.scroll( { top : scrollTop, behavior : 'silent' } );

					this.categoryName = detail.category || '';

					// Announce the page's title
					if ( detail.title ) {
						document.title = detail.title + ' - BLOG';
						this._announce( detail.title + ', loaded' );
					}
				}

				// Elements in the app can notify a change to be a11y announced.
				_onAnnounce ( e ) {
					this._announce( e.detail );
				}

				// A11y announce the given message.
				_announce ( message ) {
					this._a11yLabel         = '';
					this._announceDebouncer = Polymer.Debouncer.debounce( this._announceDebouncer,
							Polymer.Async.timeOut.after( 100 ), () => {
								this._a11yLabel = message;
							} );
				}

				// This is for performance logging only.
				_domChange ( e ) {
					if ( window.performance && performance.mark && !this.__loggedDomChange ) {
						let target = e.composedPath()[ 0 ];
						let host   = target.getRootNode().host;
						if ( host && host.localName.match( this.page ) ) {
							this.__loggedDomChange = true;
							performance.mark( host.localName + '.domChange' );
						}
					}
				}

				_onFallbackSelectionTriggered () {
					this.page = '404';
				}

				_authenticated ( e ) {
					if ( e.detail && e.detail.user && e.detail.token ) {
						this.token = e.detail.token;
						this.user  = e.detail.user;
						this.set( 'authenticated', true );
					}
				}

				_logOut () {
					this.set( 'token', null );
					this.set( 'user', null );
					this.set( 'authenticated', false );
					this.set( 'route.path', '/home' );
				}

				_submitLogin () {
					if ( !( this.$.loginUsername.invalid || this.$.loginPassword.invalid ) && !this.authenticated ) {
						this.formBody = {
							userName : this.$.loginUsername.value,
							password : this.$.loginPassword.value
						};
						this.$.loginIA.generateRequest();
					}
				}

				_computeLoginDisabled ( usernameInvalid, password ) {
					return !( usernameInvalid || ( password && password.length ? password.length >= 8 : false ) );
				}

				_computeShouldShowTabs ( page, smallScreen ) {
					return (page === 'home' || page === 'list' || page === 'detail') && !smallScreen;
				}

				_computeShouldRenderTabs ( _shouldShowTabs, loadComplete ) {
					return _shouldShowTabs && loadComplete;
				}

				_computeShouldRenderDrawer ( smallScreen, loadComplete ) {
					return smallScreen && loadComplete;
				}

				_openDialog () {
					if ( this.authenticated ) {
						this.$.profileDialog.open();
					} else {
						this.$.loginDialog.$.dialog.open();
					}

				}
			}

			customElements.define( BlogApp.is, BlogApp );

	</script>

</dom-module>
